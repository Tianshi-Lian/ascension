name: CI build

on:
  push:
    branches: main
  pull_request:

jobs:
  build:
    runs-on: windows-latest
    strategy:
      fail-fast: false
    steps:

    - name: Cache WinLibs
      id: cache-winlibs
      uses: actions/cache@v3
      env:
        cache-name: cache-winlibs-tools
      with:
        path: C:\mingw64
        key: ${{ runner.os }}-build-${{ env.cache-name }}

    - if: ${{ steps.cache-winlibs.outputs.cache-hit != 'true' }}
      name: Download WinLibs
      run: |
        Invoke-WebRequest -Uri https://github.com/brechtsanders/winlibs_mingw/releases/download/12.2.0-15.0.7-10.0.0-ucrt-r4/winlibs-x86_64-posix-seh-gcc-12.2.0-llvm-15.0.7-mingw-w64ucrt-10.0.0-r4.zip -OutFile C:\winlibs.zip
        Expand-Archive C:\winlibs.zip -DestinationPath C:\

    - name: Configure WinLibs Path
      run: $env:Path += "C:\mingw64\bin"

    - name: Checkout
      uses: actions/checkout@v3

    - name: Configure
      run: |
        cmake -GNinja -B build -S . -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_COMPILER="C:/mingw64/bin/clang.exe" -DCMAKE_CXX_COMPILER="C:/mingw64/bin/clang++.exe"

    - name: Build
      run: |
        Ninja -C build
